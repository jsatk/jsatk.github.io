<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Testing Promise Rejections with Chai-As-Promised · Jesse Atkinson
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Jesse Atkinson">
<meta name="description" content="I was recently working on a new npm module for work which is a promise-based API. Testing promises in javascript is very do-able, but also very tricky. You can test promises and their results in many various ways. Unfortunately the JS community seems still somewhat divided on how to properly test promises.
The biggest problem I faced was that I needed to mock a third-party API. I avoid stubbing as much as humanly possible, but it is often necessary when testing third party code. I&rsquo;m a strong believer in that your unit tests should run in an isolated (read: offline) environment. I use Sinon when I need to mock out dependency functionality.">
<meta name="keywords" content="blog,developer,personal">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Testing Promise Rejections with Chai-As-Promised">
  <meta name="twitter:description" content="I was recently working on a new npm module for work which is a promise-based API. Testing promises in javascript is very do-able, but also very tricky. You can test promises and their results in many various ways. Unfortunately the JS community seems still somewhat divided on how to properly test promises. The biggest problem I faced was that I needed to mock a third-party API. I avoid stubbing as much as humanly possible, but it is often necessary when testing third party code. I’m a strong believer in that your unit tests should run in an isolated (read: offline) environment. I use Sinon when I need to mock out dependency functionality.">

<meta property="og:url" content="https://jsatk.us/posts/testing-promise-rejections-with-chai-as-promised/">
  <meta property="og:site_name" content="Jesse Atkinson">
  <meta property="og:title" content="Testing Promise Rejections with Chai-As-Promised">
  <meta property="og:description" content="I was recently working on a new npm module for work which is a promise-based API. Testing promises in javascript is very do-able, but also very tricky. You can test promises and their results in many various ways. Unfortunately the JS community seems still somewhat divided on how to properly test promises. The biggest problem I faced was that I needed to mock a third-party API. I avoid stubbing as much as humanly possible, but it is often necessary when testing third party code. I’m a strong believer in that your unit tests should run in an isolated (read: offline) environment. I use Sinon when I need to mock out dependency functionality.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2016-10-19T00:00:00+00:00">
    <meta property="article:modified_time" content="2016-10-19T00:00:00+00:00">




<link rel="canonical" href="https://jsatk.us/posts/testing-promise-rejections-with-chai-as-promised/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css" integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm&#43;MTzNJdv80k&#43;n0=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://jsatk.us/">
      Jesse Atkinson
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/et-cetera/">Et Cetera</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://jsatk.us/posts/testing-promise-rejections-with-chai-as-promised/">
              Testing Promise Rejections with Chai-As-Promised
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2016-10-19T00:00:00Z">
                October 19, 2016
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <p>I was recently working on a new npm module for work which is a promise-based API. Testing promises in javascript is very do-able, but also very tricky. You can test promises and their results in many various ways. Unfortunately the JS community seems still somewhat divided on how to properly test promises.
The biggest problem I faced was that I needed to mock a third-party API. I avoid stubbing as much as humanly possible, but it is often necessary when testing third party code. I&rsquo;m a strong believer in that your unit tests should run in an isolated (read: offline) environment. I use <a href="https://sinonjs.org/"  class="external-link" target="_blank" rel="noopener">Sinon</a> when I need to mock out dependency functionality.</p>
<p>I knew about the lovely <a href="https://github.com/domenic/chai-as-promised"  class="external-link" target="_blank" rel="noopener">chai-as-promised</a>, but I stubbornly resisted adding another dependency to my <code>package.json</code>. After creating a <a href="https://en.wikipedia.org/wiki/Rube_Goldberg_machine"  class="external-link" target="_blank" rel="noopener">Rube Goldberg machine</a> to test my promises, I gave in and added chai-as-promised to my module. And for a brief moment I was happy.</p>
<hr>
<p>So I write a test and watch it fail (like the good TDD developer I am). Here&rsquo;s a simplified psuedo example of what I was working on below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">thirdPartyClient</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;some-third-party-client&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">myApi</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;../../src/my-api&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;myApi&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;Error handling&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRejection</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">errorCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">404</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">errorMessage</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;You broke everything&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">errorUrl</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://coolapp.api.docs/error/404/&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">beforeEach</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">stub</span>(<span style="color:#a6e22e">thirdPartyClient</span>.<span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#39;dingus&#39;</span>)
</span></span><span style="display:flex;"><span>         .<span style="color:#a6e22e">returns</span>(Promise.<span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">myRejection</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">afterEach</span>(() =&gt; <span style="color:#a6e22e">thirdPartyClient</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">dingus</span>.<span style="color:#a6e22e">restore</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;should be rejected with the correct error object&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">expected</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">myRejection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">myApi</span>.<span style="color:#a6e22e">someMethod</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">actual</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">thirdPartyClient</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">dingus</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">actual</span>).<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">be</span>.<span style="color:#a6e22e">rejectedWith</span>(<span style="color:#a6e22e">expected</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>I watch it fail.</p>
<p>I write the code.</p>
<p>I watch it pass.</p>
<p>Success, right?</p>
<p>Something didn&rsquo;t feel right. So I decided I wanted to see this test fail again. I added a <code>not</code> to the <code>expect</code> statement on line 21 so that it read <code>return expect(actual).not.to.be.rejectedWith(expected)</code>. Unfortunately this also passed.</p>
<p>I realized I wasn&rsquo;t doing a deep comparison on the rejection. It was simply testing to see if it was indeed an object and passing if it was.
So how do I test if a promise is rejected and also deeply test the rejection?</p>
<hr>
<p>My coworker <a href="https://medium.com/u/d41b471adec6?source=post_page-----c65c7c33f329----------------------"  class="external-link" target="_blank" rel="noopener">Pete Hodgson</a> mentioned that the latest version of chai-as-promised supports some very declarative syntax and gave me this example: <code>expect(foo).to.be.rejected.and.eventually.have.property('quxx')</code>. I was overjoyed.</p>
<p>Now I had a way to both test if something was rejected but also what the rejection actually was.</p>
<p>I updated the above code to now read:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">thirdPartyClient</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;some-third-party-client&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">myApi</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;../../src/my-api&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;myApi&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;Error handling&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRejection</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">errorCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">404</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">errorMessage</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;You broke everything&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">errorUrl</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://coolapp.api.docs/error/404/&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">beforeEach</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">stub</span>(<span style="color:#a6e22e">thirdPartyClient</span>.<span style="color:#a6e22e">prototype</span>, <span style="color:#e6db74">&#39;dingus&#39;</span>)
</span></span><span style="display:flex;"><span>         .<span style="color:#a6e22e">returns</span>(Promise.<span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">myRejection</span>)
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">afterEach</span>(() =&gt; <span style="color:#a6e22e">thirdPartyClient</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">dingus</span>.<span style="color:#a6e22e">restore</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;should be rejected with the correct error object&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">expected</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">myRejection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">myApi</span>.<span style="color:#a6e22e">someMethod</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">actual</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">thirdPartyClient</span>.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">dingus</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">expect</span>(<span style="color:#a6e22e">actual</span>).<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">be</span>.<span style="color:#a6e22e">rejected</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>.<span style="color:#a6e22e">to</span>.<span style="color:#a6e22e">eventually</span>.<span style="color:#a6e22e">deep</span>.<span style="color:#a6e22e">equal</span>(<span style="color:#a6e22e">expected</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>This is not only much easier to read but allows for a deep equals comparison on the rejection.</p>
<hr>
<p>In summary, there is now a nice and declarative way to test promises and what they actually return using chai-as-promised. I avoid adding unnecessary dependencies, but I found the benefits here far outweighed the cost of having another dependency.</p>
<p>Thanks for reading and I hope this was helpful!</p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     Jesse Atkinson 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
